<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Vosk Browser Test (URL指定・修正版)</title>
    <style>
        /* スタイルは変更なし */
        body { font-family: sans-serif; padding: 20px; }
        #controls, #status, #result { margin-bottom: 15px; }
        #model_url { width: 100%; max-width: 600px; padding: 5px; }
        button { padding: 10px 15px; font-size: 16px; }
        textarea { width: 100%; height: 150px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>Vosk.js ローカル音声認識テスト (URL指定・修正版)</h1>
    <div id="controls">
        <label for="model_url">モデルのURL:</label>
        <!-- 
          【重要】URLの末尾をフォルダ名で終わらせず、
          その中にあるファイル `model.conf` まで指定します。
        -->
        <input type="text" id="model_url" value="https://nyantorusabu.github.io/NekoExtensions/vosk-model-small-ja-0.22/model.conf">
        <p>
            <small>※上記のURLを、ご自身でホスティングしたものに書き換えてください。</small>
        </p>
        <button id="startBtn">認識開始</button>
        <button id="stopBtn" disabled>認識停止</button>
    </div>

    <div id="status">ステータス: 待機中</div>
    <h3>中間認識結果:</h3>
    <div id="partial_result" style="border: 1px solid #ccc; padding: 10px; min-height: 30px;"></div>
    <h3>最終認識結果:</h3>
    <textarea id="final_result" readonly></textarea>

    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/vosk-browser@0.0.3/dist/vosk.js"></script>
    <script>
        // JavaScript部分は変更ありません
        const modelUrlInput = document.getElementById('model_url');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const partialResultDiv = document.getElementById('partial_result');
        const finalResultTextarea = document.getElementById('final_result');

        let model, recognizer, audioContext, source, recognizerNode;

        function updateStatus(message) {
            statusDiv.textContent = `ステータス: ${message}`;
        }

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            stopBtn.disabled = false;
            finalResultTextarea.value = '';
            partialResultDiv.textContent = '';
            
            try {
                updateStatus('モデルを読み込んでいます... (時間がかかる場合があります)');
                model = await Vosk.createModel(modelUrlInput.value);
                updateStatus('モデルの読み込みが完了しました。');
                model.setLogLevel(-1);
                recognizer = new model.KaldiRecognizer(16000);

                recognizer.on("result", (message) => {
                    finalResultTextarea.value += `${message.result.text}\n`;
                });
                recognizer.on("partialresult", (message) => {
                    partialResultDiv.textContent = message.result.partial;
                });

                updateStatus('マイクへのアクセスを許可してください...');
                const mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        channelCount: 1,
                        sampleRate: 16000
                    },
                });

                audioContext = new AudioContext();
                recognizerNode = audioContext.createScriptProcessor(4096, 1, 1);
                recognizerNode.onaudioprocess = (event) => {
                    try {
                        recognizer.acceptWaveform(event.inputBuffer);
                    } catch (error) {
                        console.error('acceptWaveform failed', error);
                    }
                };
                source = audioContext.createMediaStreamSource(mediaStream);
                source.connect( recognizerNode );
                recognizerNode.connect(audioContext.destination);
                updateStatus('認識中です... 話してください。');
            } catch (error) {
                console.error(error);
                updateStatus(`エラーが発生しました: ${error.message}`);
                stopRecognition();
            }
        });

        stopBtn.addEventListener('click', () => {
            stopRecognition();
        });

        function stopRecognition() {
            if (source) source.disconnect();
            if (recognizerNode) recognizerNode.disconnect();
            if (audioContext) audioContext.close();
            if (recognizer) recognizer.remove();
            if (model) model.terminate();
            source = recognizerNode = audioContext = recognizer = model = null;
            updateStatus('待機中');
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    </script>
</body>
</html>